version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Ensure correct Node version
        - nvm install 20
        - nvm use 20

        # Enable corepack (pnpm)
        - corepack enable
        - corepack prepare pnpm@latest --activate

        # Clean caches to avoid stale modules
        - rm -rf node_modules
        - pnpm install --frozen-lockfile --shamefully-hoist
    build:
      commands:
        # Run Astro build
        - pnpm run build
  artifacts:
    baseDirectory: dist   # Astro builds into "dist"
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - pnpm-store/**/*
      - pnpm-lock.yaml

